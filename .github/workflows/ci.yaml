name: GitHub Actions CI build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:

  update-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check if version.h was modified
        id: check_version
        run: |
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git ls-files --modified)
          fi
          
          if echo "$CHANGED_FILES" | grep -q "src/pogosim/version.h"; then
            echo "VERSION_CHANGED=true" >> $GITHUB_ENV
          else
            echo "VERSION_CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Extract Version (if changed)
        if: env.VERSION_CHANGED == 'true'
        run: |
          VERSION=$(grep -oP '(?<=#define POGOSIM_VERSION ")[^"]*' src/pogosim/version.h)
          echo "{\"schemaVersion\":1,\"label\":\"version\",\"message\":\"$VERSION\",\"color\":\"blue\"}" > version.json

      - name: Commit and push (if changed)
        if: env.VERSION_CHANGED == 'true'
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add version.json
          git commit -m "Update version badge to $VERSION"
          git push
        continue-on-error: true

  build-and-test:
    strategy:
      matrix:
        #os: [ubuntu-latest, macos-latest, windows-latest]  # Test on multiple OS
        #os: [ubuntu-latest, macos-latest]  # Test on multiple OS
        os: [ubuntu-latest]  # Test on multiple OS
    runs-on: ${{ matrix.os }}

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install dependencies (Ubuntu)
      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y build-essential cmake git libboost-system-dev libsdl2-dev libsdl2-image-dev libsdl2-gfx-dev libsdl2-ttf-dev libyaml-cpp-dev libspdlog-dev wget unzip ca-certificates lsb-release

          # Install Apache Arrow
          wget https://apache.jfrog.io/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt install -y -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt update
          sudo apt install -y -V libarrow-dev
          
          # Install Box2D
          git clone https://github.com/erincatto/box2d.git
          cd box2d
          git checkout 28adacf82377d4113f2ed00586141463244b9d10
          mkdir build
          cd build
          cmake -DBOX2D_BUILD_DOCS=OFF -DGLFW_BUILD_WAYLAND=OFF -DCMAKE_INSTALL_PREFIX=/usr ..
          cmake --build .
          sudo make install
          cd ../..

      # Step 2: Install dependencies (macOS)
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install cmake boost sdl2 sdl2_image sdl2_gfx sdl2_ttf yaml-cpp spdlog box2d apache-arrow

      # Step 2: Install dependencies (Windows)
      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake git boost sdl2 sdl2_image sdl2_ttf yaml-cpp spdlog -y

          # Install Box2D
          git clone https://github.com/erincatto/box2d.git
          cd box2d
          git checkout 28adacf82377d4113f2ed00586141463244b9d10
          mkdir build
          cd build
          cmake -DBOX2D_BUILD_DOCS=OFF -DCMAKE_INSTALL_PREFIX="C:/Program Files/Box2D" ..
          cmake --build .
          cmake --install . --prefix "C:/Program Files/Box2D"
          cd ../..

      # Step 3: Build the project
      - name: Build
        run: |
          ./build.sh Release

#      # Step 4: Run tests
#      - name: Run tests
#        run: |
#          cd build
#          ctest --output-on-failure
#
#      # Step 5: Static code analysis with cppcheck (optional)
#      - name: Static analysis with cppcheck
#        run: |
#          cppcheck --enable=all --inconclusive --std=c++17 --quiet --suppress=missingIncludeSystem .
#
#      # Step 6: Upload build artifacts (optional)
#      - name: Upload build artifacts
#        uses: actions/upload-artifact@v3
#        with:
#          name: build-output
#          path: build/
