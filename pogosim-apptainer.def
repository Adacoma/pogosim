Bootstrap: docker
From: ubuntu:24.04

%labels
    Author leo.cazenille@gmail.com
    Version 0.1.0

%arguments
   USE_CLANG="false"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export DEBIAN_FRONTEND=noninteractive
    export CMAKE_MODULE_PATH="/opt/pogosim/cmake/modules"
    export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
    export PATH="/usr/local/bin:$PATH"

%files
    # Copy project source files to the container
    ./build.sh /opt/pogosim/
    ./CMakeLists.txt /opt/pogosim/
    ./src /opt/pogosim/src
    ./cmake /opt/pogosim/cmake
    ./fonts /opt/pogosim/fonts
    ./arenas /opt/pogosim/arenas

    # Copy CMakeLists.txt to the container
    ./CMakeLists.txt /opt/pogosim/CMakeLists.txt


%post
    echo 'Acquire::Retries "10";' > /etc/apt/apt.conf.d/80-retries
    # Update and install required packages
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        libboost-system-dev \
        libsdl2-dev \
        libsdl2-image-dev \
        libsdl2-gfx-dev \
        libsdl2-ttf-dev \
        libyaml-cpp-dev \
        libspdlog-dev \
        wget \
        unzip \
        ca-certificates lsb-release

    # Install Apache Arrow
    wget https://apache.jfrog.io/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
    apt install -y -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
    apt update && apt install -y -V libarrow-dev

    # Install clang if USE_CLANG is true
    if [ {{ USE_CLANG }} = "true" ]; then
        apt-get install -y --no-install-recommends clang
        update-alternatives --install /usr/bin/cc cc /usr/bin/clang 100
        update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++ 100
    fi

    # Clean apt cache
    apt-get clean && rm -rf /var/lib/apt/lists/*

    # Install Box2D 3.x
    git clone https://github.com/erincatto/box2d.git
    cd box2d
    git checkout 28adacf82377d4113f2ed00586141463244b9d10       # This commit compiles fine
    mkdir build
    cd build
    cmake -DBOX2D_BUILD_DOCS=OFF -DGLFW_BUILD_WAYLAND=OFF    -DCMAKE_INSTALL_PREFIX=/usr  ..
    cmake --build .
    make install
    cd ../..

    # Create a working directory
    mkdir -p /opt/pogosim
    cd /opt/pogosim

    # Compile and install
    /opt/pogosim/build.sh

